<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()"/>
        <link rel="stylesheet" href="https://wsbctechnicalblog.github.io/theme/css/foundation.min.css" media="all">
        <script type="text/javascript" src="https://wsbctechnicalblog.github.io/theme/js/modernizr.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Exo+2:400,300,700,300italic,400italic,700italic,900,900italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://wsbctechnicalblog.github.io/theme/css/lamboz.css" media="all">
        <title>Azure DevOps Pipeline Blueprints - Exploring the Continuous Delivery (CD) templates - </title>
        <meta charset="utf-8" />
        
</head>
<body>
    <div class="pages">
        <ul>
            <li class="home"><a href="https://wsbctechnicalblog.github.io/index.html">Home</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/about.html">About</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/authors.html">Authors</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/copyright.html">Copyright</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/privacy.html">Privacy and Security</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/terms-of-use.html">Terms of Use</a></li>
        </ul>
    </div>
<div class="hp-header-inner">
    <div class="page-header">
        <div class="content-header">
        </div>
    </div>
</div>
    <div class="content">
        <div class="data-holder">
        <div class="row">
           <div class="large-10 content-column column">
    <h1 style="font-size:2em;"><a href="https://wsbctechnicalblog.github.io/azure-pipeline-blueprints-explore-cd.html" rel="bookmark"
            title="Permalink to Azure DevOps Pipeline Blueprints - Exploring the Continuous Delivery (CD) templates">Azure DevOps Pipeline Blueprints - Exploring the Continuous Delivery (CD) templates</a></h1>

<img src="/theme/img/Logo-blogsize.png"><br />
<div class="content-article">
    <header class="header-article">
        <div class="read-more">Posted by Willy-Peter Schaub on Wed 05 February 2025</div>
 
   </header>
    <section class='article'>
        
        <div class="entry-summary">
            <p>Drilling Deeper: A Closer Look at the Blueprint Continuous Delivery (CD) Templates.</p>
        </div>
    
        <div class="entry-content">
            <p>We continue our deep dive into the details of our <a href="https://github.com/WorkSafeBC-Common-Engineering/AzureDevOps.Automation.Pipeline.Templates.v2">AzureDevOps.Automation.Pipeline.Templates.v2</a> open source blueprint repo. Today we are going to explore the <a href="https://github.com/WorkSafeBC-Common-Engineering/AzureDevOps.Automation.Pipeline.Templates.v2/blob/master/blueprints/universal-artifact/azure-pipeline-universal-artifact-cd.yml">blueprints/universal-artifact/azure-pipeline-universal-artifact-cd.yml</a> and <a href="https://github.com/WorkSafeBC-Common-Engineering/AzureDevOps.Automation.Pipeline.Templates.v2/blob/master/blueprints/universal-artifact/azure-pipeline-universal-artifact-cd-stage.yml">blueprints/universal-artifact/azure-pipeline-universal-artifact-cd-stage.yml</a> templates, which are part of our Universal Azure Artifact templates.</p>
<blockquote>
<p><img alt="drilling" src="../images/azure-pipeline-blueprints-explore-cd-0.png"></p>
</blockquote>
<p>Also refer to:</p>
<ul>
<li><a href="/azure-pipeline-blueprints-explore-start.html">Azure DevOps Pipeline Blueprints - Exploring the start template</a>.</li>
<li><a href="/azure-pipeline-blueprints-explore-version.html">Azure DevOps Pipeline Blueprints - Exploring the version template</a>.</li>
<li><a href="/azure-pipeline-blueprints-explore-info.html">Azure DevOps Pipeline Blueprints - Exploring the info template</a>.</li>
<li><a href="/azure-pipeline-blueprints-explore-qa-scans.html">Azure DevOps Pipeline Blueprints - Exploring the QA Scan templates</a>.</li>
<li><a href="/why-pipelines-part1.html">Pipelines - Why bother and what are our nightmares and options?</a> blog series.</li>
<li><a href="/sharing-variables-amongst-agents.html">How to share variables amongst Azure Pipeline agents</a>.</li>
<li><a href="/sharing-variables-with-stages-and-jobs.html">Gotchas when sharing variables with Azure DevOps stages and jobs</a>.</li>
</ul>
<hr>
<h1>Today's topics - azure-pipeline-universal-artifact-cd.yml and azure-pipeline-universal-artifact-cd-stage.yml templates</h1>
<p>Today we start with the <a href="https://github.com/WorkSafeBC-Common-Engineering/AzureDevOps.Automation.Pipeline.Templates.v2/blob/master/blueprints/universal-artifact/azure-pipeline-universal-artifact-cd.yml">blueprints/universal-artifact/azure-pipeline-universal-artifact-cd.yml</a> template which is triggered by the <code>*-control.yml</code> template, which controls the Continuous Delivery (CD) flow, and calls the various review, security, and QA scans.</p>
<blockquote>
<p><strong>azure-pipeline-universal-artifact-cd.yml.yml</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">parameters</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w">     </span><span class="n">stage</span>
<span class="w">  </span><span class="n">type</span><span class="p">:</span><span class="w">     </span><span class="n">object</span>

<span class="n">stages</span><span class="p">:</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># DEVELOPMENT STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">blueprints</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">-</span><span class="n">cd</span><span class="o">-</span><span class="n">stage</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">name</span><span class="p">:</span><span class="w">                           </span><span class="n">Development</span>
<span class="w">      </span><span class="n">displayName</span><span class="p">:</span><span class="w">                    </span><span class="n">Development</span><span class="w"> </span><span class="p">(</span><span class="n">DV</span><span class="p">)</span>
<span class="w">      </span><span class="n">config</span><span class="p">:</span><span class="w">                         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># SYSTEM TEST STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">blueprints</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">-</span><span class="n">cd</span><span class="o">-</span><span class="n">stage</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">name</span><span class="p">:</span><span class="w">                           </span><span class="n">SystemTest</span>
<span class="w">      </span><span class="n">displayName</span><span class="p">:</span><span class="w">                    </span><span class="n">System</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">(</span><span class="n">SY</span><span class="p">)</span>
<span class="w">      </span><span class="n">config</span><span class="p">:</span><span class="w">                         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># SECURITY AUTOMATION STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">sec</span><span class="o">-</span><span class="n">ops</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">security</span><span class="o">-</span><span class="n">auto</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">  </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">    </span><span class="n">applicationBlueprint</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">securityAutomation</span><span class="o">.</span><span class="n">applicationBlueprint</span><span class="p">}}</span>
<span class="w">    </span><span class="n">modeElite</span><span class="p">:</span><span class="w">            </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">securityAutomation</span><span class="o">.</span><span class="n">modeElite</span><span class="p">}}</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># QA SCANS STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">qa</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">qa</span><span class="o">-</span><span class="n">scans</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">  </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">    </span><span class="n">applicationBlueprint</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">qaScans</span><span class="o">.</span><span class="n">applicationBlueprint</span><span class="p">}}</span>
<span class="w">    </span><span class="n">modeElite</span><span class="p">:</span><span class="w">            </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">qaScans</span><span class="o">.</span><span class="n">modeElite</span><span class="p">}}</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># SECURITY REVIEW STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">sec</span><span class="o">-</span><span class="n">ops</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">security</span><span class="o">-</span><span class="n">review</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">applicationBlueprint</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">securityReview</span><span class="o">.</span><span class="n">applicationBlueprint</span><span class="p">}}</span>
<span class="w">      </span><span class="n">stageEnvName</span><span class="p">:</span><span class="w">         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">securityReview</span><span class="o">.</span><span class="n">envName</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityAutomation</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># STAGING STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">and</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">),</span><span class="w"> </span><span class="ow">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release/&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">blueprints</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">-</span><span class="n">cd</span><span class="o">-</span><span class="n">stage</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">name</span><span class="p">:</span><span class="w">                           </span><span class="n">Staging</span>
<span class="w">      </span><span class="n">displayName</span><span class="p">:</span><span class="w">                    </span><span class="n">Staging</span><span class="w"> </span><span class="p">(</span><span class="n">ST</span><span class="p">)</span>
<span class="w">      </span><span class="n">config</span><span class="p">:</span><span class="w">                         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">QAScans</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityAutomation</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityReview</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># PRE-PROD AUTOMATION SCANS STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">and</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">),</span><span class="w"> </span><span class="ow">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release/&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">pre</span><span class="o">-</span><span class="n">prod</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">pre</span><span class="o">-</span><span class="n">prod</span><span class="o">-</span><span class="n">automation</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">applicationBlueprint</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">preProdAutomation</span><span class="o">.</span><span class="n">applicationBlueprint</span><span class="p">}}</span>
<span class="w">      </span><span class="n">modeElite</span><span class="p">:</span><span class="w">            </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">preProdAutomation</span><span class="o">.</span><span class="n">modeElite</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">QAScans</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityAutomation</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityReview</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Staging</span>

<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># PRODUCTION STAGE</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">and</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">),</span><span class="w"> </span><span class="ow">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release/&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">blueprints</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">-</span><span class="n">cd</span><span class="o">-</span><span class="n">stage</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">name</span><span class="p">:</span><span class="w">                           </span><span class="n">Production</span>
<span class="w">      </span><span class="n">displayName</span><span class="p">:</span><span class="w">                    </span><span class="n">Production</span><span class="w"> </span><span class="p">(</span><span class="n">PR</span><span class="p">)</span>
<span class="w">      </span><span class="n">config</span><span class="p">:</span><span class="w">                         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">QAScans</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityAutomation</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityReview</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Staging</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">PreProdAutomation</span>
</code></pre></div>

<p>This template, as shown above, triggers the <a href="https://github.com/WorkSafeBC-Common-Engineering/AzureDevOps.Automation.Pipeline.Templates.v2/blob/master/blueprints/universal-artifact/azure-pipeline-universal-artifact-cd-stage.yml">blueprints/universal-artifact/azure-pipeline-universal-artifact-cd-stage.yml</a> template for each deployment stage.</p>
<blockquote>
<p><strong>azure-pipeline-universal-artifact-cd-stage.yml</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nl">parameters</span><span class="p">:</span>
<span class="p">-</span> <span class="nf">name:</span><span class="w">     </span><span class="n">name</span>
<span class="w">  </span><span class="nl">type</span><span class="p">:</span><span class="w">     </span><span class="n">string</span>
<span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w">     </span><span class="n">displayName</span>
<span class="w">  </span><span class="nl">type</span><span class="p">:</span><span class="w">     </span><span class="n">string</span>
<span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w">     </span><span class="n">config</span>
<span class="w">  </span><span class="nl">type</span><span class="p">:</span><span class="w">     </span><span class="n">object</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span><span class="w">  </span><span class="p">[]</span>
<span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w">     </span><span class="n">dependsOn</span>
<span class="w">  </span><span class="nl">type</span><span class="p">:</span><span class="w">     </span><span class="n">object</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span><span class="w">  </span><span class="p">[]</span>

<span class="nl">stages</span><span class="p">:</span>

<span class="cp"># -----------------------------------------------------------------------------------------------------</span>
<span class="cp"># STAGE</span>
<span class="cp"># -----------------------------------------------------------------------------------------------------</span>

<span class="o">-</span><span class="w"> </span><span class="n">stage</span><span class="o">:</span><span class="w">         </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">name</span><span class="p">}}</span>
<span class="w">  </span><span class="nl">displayName</span><span class="p">:</span><span class="w">   </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">displayName</span><span class="p">}}</span>
<span class="w">  </span><span class="n">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ne</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">dependsOn</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}}</span><span class="o">:</span>
<span class="w">    </span><span class="nl">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">parameters</span><span class="p">.</span><span class="n">dependsOn</span><span class="w"> </span><span class="p">}}</span><span class="o">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="n">stage</span><span class="p">}}</span>
<span class="w">  </span><span class="nl">variables</span><span class="p">:</span>
<span class="w">      </span><span class="nl">currentVersion</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">[</span><span class="w"> </span><span class="n">stageDependencies</span><span class="p">.</span><span class="n">ContinuousIntegration</span><span class="p">.</span><span class="n">ContinuousIntegration</span><span class="p">.</span><span class="n">outputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">setSemVersion</span><span class="p">.</span><span class="n">semVersion</span><span class="err">&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="nl">pool</span><span class="p">:</span>
<span class="w">    </span><span class="nl">vmImage</span><span class="p">:</span><span class="w">     </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">nameVM</span><span class="p">}}</span>
<span class="w">  </span><span class="nl">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">deployment</span><span class="o">:</span><span class="w">  </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">name</span><span class="p">}}</span>
<span class="w">    </span><span class="nl">environment</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">nameEnv</span><span class="p">}}</span>
<span class="w">    </span><span class="nl">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nl">runOnce</span><span class="p">:</span>
<span class="w">        </span><span class="nl">deploy</span><span class="p">:</span>
<span class="w">          </span><span class="nl">steps</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">script</span><span class="o">:</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">Toolkit</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="n">currentVersion</span><span class="p">)</span>
<span class="w">          </span><span class="cp"># For release we enforce the toolkit version</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="o">/</span><span class="err">&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">}}</span><span class="o">:</span>
<span class="w">            </span><span class="o">-</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">UniversalPackages</span><span class="mi">@0</span>
<span class="w">              </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Create_Universal_Package</span>
<span class="w">              </span><span class="nl">inputs</span><span class="p">:</span>
<span class="w">                </span><span class="nl">command</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="n">publish</span><span class="err">&#39;</span>
<span class="w">                </span><span class="nl">publishDirectory</span><span class="p">:</span><span class="w">       </span><span class="n">$</span><span class="p">(</span><span class="n">Agent</span><span class="p">.</span><span class="n">BuildDirectory</span><span class="p">)</span><span class="o">/</span><span class="n">drop</span>
<span class="w">                </span><span class="nl">feedsToUsePublish</span><span class="p">:</span><span class="w">      </span><span class="err">&#39;</span><span class="n">internal</span><span class="err">&#39;</span>
<span class="w">                </span><span class="nl">vstsFeedPublish</span><span class="p">:</span><span class="w">        </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">feedPublish</span><span class="p">}}</span>
<span class="w">                </span><span class="nl">vstsFeedPackagePublish</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">packagePublish</span><span class="p">}}</span>
<span class="w">                </span><span class="nl">versionOption</span><span class="p">:</span><span class="w">          </span><span class="err">&#39;</span><span class="n">custom</span><span class="err">&#39;</span>
<span class="w">                </span><span class="nl">versionPublish</span><span class="p">:</span><span class="w">         </span><span class="n">$</span><span class="p">(</span><span class="n">currentVersion</span><span class="p">)</span>
<span class="w">          </span><span class="cp"># For non-release we increment the minor version so that we do not have to tag for DV feeds</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">not</span><span class="p">(</span><span class="n">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="o">/</span><span class="err">&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">}}</span><span class="o">:</span>
<span class="w">            </span><span class="o">-</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">UniversalPackages</span><span class="mi">@0</span>
<span class="w">              </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Create_Universal_Package</span>
<span class="w">              </span><span class="nl">inputs</span><span class="p">:</span>
<span class="w">                </span><span class="nl">command</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="n">publish</span><span class="err">&#39;</span>
<span class="w">                </span><span class="nl">publishDirectory</span><span class="p">:</span><span class="w">       </span><span class="n">$</span><span class="p">(</span><span class="n">Agent</span><span class="p">.</span><span class="n">BuildDirectory</span><span class="p">)</span><span class="o">/</span><span class="n">drop</span>
<span class="w">                </span><span class="nl">feedsToUsePublish</span><span class="p">:</span><span class="w">      </span><span class="err">&#39;</span><span class="n">internal</span><span class="err">&#39;</span>
<span class="w">                </span><span class="nl">vstsFeedPublish</span><span class="p">:</span><span class="w">        </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">feedPublish</span><span class="p">}}</span>
<span class="w">                </span><span class="nl">vstsFeedPackagePublish</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">packagePublish</span><span class="p">}}</span>
</code></pre></div>

<hr>
<h1>Drill-down</h1>
<h3>azure-pipeline-universal-artifact-cd.yml nuggets</h3>
<p>Let us take a look at the <code>azure-pipeline-universal-artifact-cd.yml</code> blueprint template, which defines the deployment and validation stages, specifying when they are triggered and in what sequence. The first YAML snippet is part of an Azure DevOps pipeline configuration, specifically handling conditional deployment for the Production stage in a universal artifact deployment pipeline.</p>
<blockquote>
<p><strong>Gem 1</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">and</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">),</span><span class="w"> </span><span class="ow">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/heads/release/&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">blueprints</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">/</span><span class="n">azure</span><span class="o">-</span><span class="n">pipeline</span><span class="o">-</span><span class="n">universal</span><span class="o">-</span><span class="n">artifact</span><span class="o">-</span><span class="n">cd</span><span class="o">-</span><span class="n">stage</span><span class="o">.</span><span class="n">yml</span><span class="err">@</span><span class="n">CeBlueprints</span>
<span class="w">    </span><span class="n">parameters</span><span class="p">:</span>
<span class="w">      </span><span class="n">name</span><span class="p">:</span><span class="w">                           </span><span class="n">Production</span>
<span class="w">      </span><span class="n">displayName</span><span class="p">:</span><span class="w">                    </span><span class="n">Production</span><span class="w"> </span><span class="p">(</span><span class="n">PR</span><span class="p">)</span>
<span class="w">      </span><span class="n">config</span><span class="p">:</span><span class="w">                         </span><span class="o">$</span><span class="p">{{</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">production</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span>
<span class="w">      </span><span class="n">dependsOn</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">development</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Development</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">systemTest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">SystemTest</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">QAScans</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityAutomation</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">SecurityReview</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">staging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">}}:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">Staging</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">PreProdAutomation</span>
</code></pre></div>

<p>Let us break it down.</p>
<ul>
<li>The YAML snippet runs only if <code>parameters.stage.production.config.active</code> is <strong>true</strong> (enabled in the *-config.yml file and if the build source branch is <code>refs/heads/release</code> or any sub-branch under <code>refs/heads/release/</code>, for example refs/heads/release/v1.2.3.</li>
<li>Uses the <code>azure-pipeline-universal-artifact-cd-stage.yml</code> template and passes parameters like name, displayName, and the config object.</li>
<li>Establishes dependencies on multiple preceding stages to dictate the execution sequence and inherit variables from earlier stages, as outlined in <a href="/sharing-variables-amongst-agents.html">How to share variables amongst Azure Pipeline agents</a> and <a href="/sharing-variables-with-stages-and-jobs.html">Gotchas when sharing variables with Azure DevOps stages and jobs</a>.</li>
</ul>
<h3>azure-pipeline-universal-artifact-cd-stage.yml nuggets</h3>
<p>Next, let us peek into the template used by the <code>*-cd.yml</code> template.</p>
<blockquote>
<p><strong>Gem 2</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w">     </span><span class="nx">config</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w">     </span><span class="nx">object</span>
<span class="w">  </span><span class="k">default</span><span class="p">:</span><span class="w">  </span><span class="p">[]</span>
<span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w">     </span><span class="nx">dependsOn</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w">     </span><span class="nx">object</span>
<span class="w">  </span><span class="k">default</span><span class="p">:</span><span class="w">  </span><span class="p">[]</span>
</code></pre></div>

<p>This YAML snippet defines two parameters:</p>
<ul>
<li>The <code>config</code> parameter is by default an empty array, but in our case stores pipeline configuration settings.</li>
<li>The <code>dependsOn</code> parameter, also by default an empty array, specifies dependencies between stages/jobs, determining execution order.</li>
</ul>
<blockquote>
<p><strong>Gem 2</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">variables</span><span class="p">:</span>
<span class="w">      </span><span class="n">currentVersion</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">[</span><span class="w"> </span><span class="n">stageDependencies</span><span class="o">.</span><span class="n">ContinuousIntegration</span><span class="o">.</span><span class="n">ContinuousIntegration</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;setSemVersion.semVersion&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>

<p>This line defines a pipeline variable named currentVersion, which retrieves its value from the calculated version as we discussed in <a href="/azure-pipeline-blueprints-explore-version.html">Azure DevOps Pipeline Blueprints - Exploring the version template</a>.</p>
<ul>
<li>The first <code>ContinuousIntegration</code> refers to the stage name.</li>
<li>The second <code>ContinuousIntegration</code> refers to the job name within that stage.</li>
<li><code>setSemVersion</code> refers a step within the job.</li>
<li><code>semVersion</code> is the output variable from that task.</li>
</ul>
<blockquote>
<p><strong>*Gem 3</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">-</span> <span class="nf">$</span><span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">or</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">startsWith</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranch</span><span class="err">&#39;</span><span class="p">],</span><span class="w"> </span><span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="k">release</span><span class="o">/</span><span class="err">&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">}}</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">UniversalPackages</span><span class="mi">@0</span>
<span class="w">    </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Create_Universal_Package</span>
<span class="w">    </span><span class="nl">inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nl">command</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="n">publish</span><span class="err">&#39;</span>
<span class="w">      </span><span class="nl">publishDirectory</span><span class="p">:</span><span class="w">       </span><span class="n">$</span><span class="p">(</span><span class="n">Agent</span><span class="p">.</span><span class="n">BuildDirectory</span><span class="p">)</span><span class="o">/</span><span class="n">drop</span>
<span class="w">      </span><span class="nl">feedsToUsePublish</span><span class="p">:</span><span class="w">      </span><span class="err">&#39;</span><span class="n">internal</span><span class="err">&#39;</span>
<span class="w">      </span><span class="nl">vstsFeedPublish</span><span class="p">:</span><span class="w">        </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">feedPublish</span><span class="p">}}</span>
<span class="w">      </span><span class="nl">vstsFeedPackagePublish</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{{</span><span class="n">parameters</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">packagePublish</span><span class="p">}}</span>
<span class="w">      </span><span class="nl">versionOption</span><span class="p">:</span><span class="w">          </span><span class="err">&#39;</span><span class="n">custom</span><span class="err">&#39;</span>
<span class="w">      </span><span class="nl">versionPublish</span><span class="p">:</span><span class="w">         </span><span class="n">$</span><span class="p">(</span><span class="n">currentVersion</span><span class="p">)</span>
</code></pre></div>

<p>This YAML snippet defines a conditional step publishes a Universal Package to an internal feed when triggered from a release branch, using:</p>
<ul>
<li>The <code>UniversalPackages</code> task to publish artifacts.</li>
<li>Upload the package from <code>$(Agent.BuildDirectory)/drop</code>.</li>
<li>The feed and package details aprovided via <code>parameters.config</code>.</li>
<li>Using <code>$(currentVersion)</code>, as set in the ContinuousIntegration stage, to set the custom version.</li>
</ul>
<p>That is a wrap for today.</p>
<hr>
<h1>Questions</h1>
<h3>For my team</h3>
<ul>
<li>Q1: Every time I look at the per app-type control and cd blueprint template, I wonder - can we not standardize and share common templates?</li>
</ul>
<h3>For you</h3>
<ul>
<li>Q2: How are you dealing with the cd phase of your pipeline and integration of infrastructure as code (IaC)? </li>
</ul>
<hr>
<p>Any questions or suggested improvements?</p>
        </div>

    </section>
    <footer class="footer-article">
        <div class="tags-and-categories">Filed under <a href="https://wsbctechnicalblog.github.io/category/posts.html">Posts</a>
        | Tagged: <a href="https://wsbctechnicalblog.github.io/tag/azure-devops.html">azure-devops </a><a href="https://wsbctechnicalblog.github.io/tag/pipelines.html">pipelines </a><a href="https://wsbctechnicalblog.github.io/tag/engineering.html">engineering </a>
        | <a href="https://wsbctechnicalblog.github.io/azure-pipeline-blueprints-explore-cd.html" rel="bookmark"
         title="Permalink to Azure DevOps Pipeline Blueprints - Exploring the Continuous Delivery (CD) templates">Permalink</a>            
        </div>
        <!-- metaldata 
        -->
    </footer>
        <hr>
        <div id="gisqus_thread"></div>
        <script src="https://giscus.app/client.js"
            data-repo="WorkSafeBC-Common-Engineering/Common.Engineering.Discussion"
            data-repo-id="R_kgDOIGjt-Q"
            data-category="Technical Blog"
            data-category-id="DIC_kwDOIGjt-c4CU007"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="light"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
        </script></div>
            </div>
            <div class="large-2 aside column">
                <h3>Links</h3>
                <ul>
                    <li><a href="https://www.worksafebc.com/en">WorkSafeBC</a></li>
                    <li><a href="https://www.worksafebc.com/en/about-us/news-events/campaigns/2019/September/connect-to-an-it-career-with-a-difference">WorkSafeBC IT is hiring</a></li>
                    <li><a href="https://www.worksafebc.com/en/about-us/careers">Careers</a></li>
                    <li><a href="https://wsbctechnicalblog.github.io/feeds/posts.atom.xml">ATOM/RSS Feed</a></li>
                </ul>
            </div>
         </div>
    </div>
</div>
    <div class="footer">
        <div class="data-holder">
        <div class="row">
            <div class="large-3 column">
<div class="credits">
    <h3>WorkSafeBC</h3>
    <p><a href="/pages/copyright.html">Copyright</a>&nbsp;|<br /><a href="/pages/terms-of-use.html">Terms&nbsp;and&nbsp;Conditions</a></p>
</div>           </div>
           <div class="large-6 tag-cloud column">
                <h3>Tags</h3>
                <ul>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/ai.html">ai</a>(22)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/engineering.html">engineering</a>(67)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/coop.html">coop</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/feature-flags.html">feature-flags</a>(4)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/azure-devops.html">azure-devops</a>(94)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/pipelines.html">pipelines</a>(65)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/devops.html">devops</a>(55)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/agile.html">agile</a>(36)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/tips.html">tips</a>(29)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/code.html">code</a>(27)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/code-quality.html">code-quality</a>(15)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/technical-excellence.html">technical-excellence</a>(21)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/learning.html">learning</a>(53)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/automation.html">automation</a>(23)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/event.html">event</a>(10)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/posters.html">posters</a>(11)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/journal.html">journal</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/101.html">101</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/eliminate-waste.html">eliminate-waste</a>(24)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/ceremony.html">ceremony</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/quality.html">quality</a>(19)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/oss.html">oss</a>(6)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/github.html">github</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/standards.html">standards</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/azure.html">azure</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/water-cooler.html">water-cooler</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/innovation.html">innovation</a>(7)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/design.html">design</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/testing.html">testing</a>(15)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/release.html">release</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/x-as-code.html">x-as-code</a>(16)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/book.html">book</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/version-control.html">version-control</a>(4)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/metrics.html">metrics</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/continuous-delivery.html">continuous-delivery</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/delivery-on-demand.html">delivery-on-demand</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/architecture.html">architecture</a>(5)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/collaboration.html">collaboration</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/team-building.html">team-building</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/no-estimates.html">no-estimates</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/tdd.html">TDD</a>(12)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/estimates.html">estimates</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/strategy.html">strategy</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/planning.html">planning</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/value.html">value</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/process.html">process</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/flow.html">flow</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/lean.html">lean</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/customer-centric.html">customer-centric</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/psychological-safety.html">psychological-safety</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/dojo.html">dojo</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/testability.html">testability</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/system-programming.html">system-programming</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/xp.html">xp</a>(5)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/events.html">events</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/security.html">security</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/workflow.html">workflow</a>(1)</li>
                </ul>
            </div>
            <div class="large-3 category-column column">
                <h3>Categories</h3>
                <ul>
                    <li><a href="https://wsbctechnicalblog.github.io/category/events.html">Events</a> (10)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/category/misc.html">misc</a> (2)</li>
                    <li class="active"><a href="https://wsbctechnicalblog.github.io/category/posts.html">Posts</a> (230)</li>
                </ul>
             
            </div>
        </row>
        </div>
    </div>
</body>
</html>