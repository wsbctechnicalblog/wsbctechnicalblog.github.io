<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()"/>
        <link rel="stylesheet" href="https://wsbctechnicalblog.github.io/theme/css/foundation.min.css" media="all">
        <script type="text/javascript" src="https://wsbctechnicalblog.github.io/theme/js/modernizr.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Exo+2:400,300,700,300italic,400italic,700italic,900,900italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://wsbctechnicalblog.github.io/theme/css/lamboz.css" media="all">
        <title>Part 5: Pipelines - Blueprints to fuel consistency and enablement - </title>
        <meta charset="utf-8" />
        
</head>
<body>
    <div class="pages">
        <ul>
            <li class="home"><a href="https://wsbctechnicalblog.github.io/index.html">Home</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/about.html">About</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/authors.html">Authors</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/copyright.html">Copyright</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/privacy.html">Privacy and Security</a></li>
            <li ><a href="https://wsbctechnicalblog.github.io/pages/terms-of-use.html">Terms of Use</a></li>
        </ul>
    </div>
<div class="hp-header-inner">
    <div class="page-header">
        <div class="content-header">
        </div>
    </div>
</div>
    <div class="content">
        <div class="data-holder">
        <div class="row">
           <div class="large-10 content-column column">
    <h1 style="font-size:2em;"><a href="https://wsbctechnicalblog.github.io/yaml-pipelines-part5.html" rel="bookmark"
            title="Permalink to Part 5: Pipelines - Blueprints to fuel consistency and enablement">Part 5: Pipelines - Blueprints to fuel consistency and enablement</a></h1>

<img src="/theme/img/Logo-blogsize.png"><br />
<div class="content-article">
    <header class="header-article">
        <div class="read-more">Posted by Willy-Peter Schaub on Thu 28 January 2021</div>
 
   </header>
    <section class='article'>
        
        <div class="entry-summary">
            <p>Think of <strong>blueprints</strong> and associated <strong>templates</strong> as re-usable LEGO blocks, ranging from a bag of "do it yourself" blocks, to complex and detailed kits, such as the Imperial Star Destroyer.</p>
        </div>
    
        <div class="entry-content">
            <p>Welcome back to another installment of our exciting pipeline journey, as outlined in <a href="/why-pipelines-part1.html">part 1</a>. After covering some of the gems and magic in <a href="/yaml-pipelines-part4.html">part 4</a> we will peek at our pipeline blueprints.</p>
<hr>
<h1>What do we mean with pipeline blueprints?</h1>
<p>If you ask 13 software engineers to cook a continuous delivery pipeline, you are likely to get more than 13 variations. Although this enables innovation, it distracts the engineers from their core responsibility to continuously delivering functional code and value. More concerning the variations of artworks (pipelines) hamper reuse and bloat support and maintenance costs.</p>
<p>Like the building-blueprint counterpart, our <strong>generic</strong> and <strong>application-type</strong> pipeline blueprints define templates that allow rapid and consistent creation of unlimited number of continuous delivery pipeline copies. Let us have a look at a few of our blueprints.</p>
<hr>
<h1>Generic blueprints</h1>
<p>We have defined two generic blueprints. One defines a one stage, multiple jobs pipeline, allowing parallel runs on separate agents, each with multiple steps. The simpler and more recommended blueprint defines a one stage, one job, with multiple steps pipeline. It keeps things simple, running everything on one agent. </p>
<p>Both blueprints call our <strong>bootstrap</strong> template, which injects other templates introducing DevSecOps scans such as SonarQube and WhiteSource, as well as custom built <strong>building code</strong> scripts and products, based on queue-time parameters.</p>
<blockquote>
<p>azure-pipeline-single-job.yml flow
<img alt="azure-pipeline-single-job.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-1.png"></p>
</blockquote>
<p>As shown, the blueprint defines a pipeline that runs within the same <strong>job</strong> context, in a single <strong>stage</strong>. It injects the <strong>bootstrap</strong> template with an <strong>init</strong> parameter, to inject initialisation templates, with tasks such as <strong>SonarQube Prepare</strong>.</p>
<blockquote>
<p>Example: SonarQube Prepare for .NET applications</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c"># </span><span class="nb">--------------------------------------------------------------------------</span>
<span class="c"># SONARQUBE </span><span class="nb">-</span><span class="c"> dotnet</span>
<span class="c"># </span><span class="nb">--------------------------------------------------------------------------</span>
<span class="nb">-</span><span class="c"> ${{ if eq( parameters</span><span class="nt">.</span><span class="c">applicationType</span><span class="nt">,</span><span class="c"> &#39;dotnet&#39; ) }}: </span>
<span class="c">  </span><span class="nb">-</span><span class="c"> task: SonarQubePrepare@4</span>
<span class="c">    displayName: &#39;SonarQube Prepare&#39;</span>
<span class="c">    inputs:</span>
<span class="c">      SonarQube:      ${{parameters</span><span class="nt">.</span><span class="c">sonarQubeService}}</span>
<span class="c">      scannerMode:    &#39;MSBuild&#39;</span>
<span class="c">      projectKey:     ${{parameters</span><span class="nt">.</span><span class="c">sonarQubeProjectKey}}</span>
<span class="c">      projectName:    ${{parameters</span><span class="nt">.</span><span class="c">sonarQubeProjectName}}</span>
<span class="c">    continueOnError:  true</span>
</code></pre></div>

<p>At the end of the continuous integration (CI) part of the pipeline, the blueprints injects the <strong>bootstrap</strong> template with a <strong>run</strong> parameter, to inject tasks such as <strong>SonarQube Analyze</strong>, <strong>SonarQube Publish</strong>, <strong>WhiteSource</strong>, and <strong>Building Code</strong> validations. Single jobs are the most efficient as dependencies, such as source code, extensions, and the bootstrap toolbox only need to be loaded once.</p>
<p>Here is the latest version of this blueprint:</p>
<blockquote>
<p>azure-pipeline-single-job.yml source code</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nl">trigger</span><span class="p">:</span>
<span class="w">  </span><span class="nl">batch</span><span class="p">:</span><span class="w"> </span><span class="nb">true</span>
<span class="w">  </span><span class="nl">branches</span><span class="p">:</span>
<span class="w">    </span><span class="nl">include</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="sc">&#39;*&#39;</span>
<span class="w">  </span><span class="nl">paths</span><span class="p">:</span>
<span class="w">    </span><span class="nl">exclude</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">pipeline</span>

<span class="cp"># Semantic version as per Azure DevOps Naming Conventions.</span>
<span class="nl">name</span><span class="p">:</span>
<span class="w">  </span><span class="n">$</span><span class="p">(</span><span class="n">portfolioName</span><span class="p">)</span><span class="n">_$</span><span class="p">(</span><span class="n">productName</span><span class="p">)</span><span class="n">_$</span><span class="p">(</span><span class="n">GITVERSION_MAJORMINORPATCH</span><span class="p">)</span><span class="n">_$</span><span class="p">(</span><span class="n">date</span><span class="o">:</span><span class="n">yyyyMMdd</span><span class="p">).</span><span class="n">$</span><span class="p">(</span><span class="n">date</span><span class="o">:</span><span class="n">HHmmss</span><span class="p">).</span><span class="n">$</span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="n">SourceBranchName</span><span class="p">)</span>

<span class="cp"># Configure the default agent pool and image to use for your pipeline</span>
<span class="nl">pool</span><span class="p">:</span>
<span class="w">  </span><span class="nl">name</span><span class="p">:</span><span class="w">                 </span><span class="err">&#39;</span><span class="n">Azure</span><span class="w"> </span><span class="n">Pipelines</span><span class="err">&#39;</span>
<span class="w">  </span><span class="nl">vmImage</span><span class="p">:</span><span class="w">              </span><span class="err">&#39;</span><span class="n">windows</span><span class="o">-</span><span class="n">latest</span><span class="err">&#39;</span>

<span class="cp"># Variables</span>
<span class="nl">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nl">BuildConfiguration</span><span class="p">:</span><span class="w">   </span><span class="n">Release</span>
<span class="w">  </span><span class="nl">BuildPlatform</span><span class="p">:</span><span class="w">        </span><span class="err">&#39;</span><span class="n">Any</span><span class="w"> </span><span class="n">CPU</span><span class="err">&#39;</span>
<span class="w">  </span><span class="nl">templateVersion</span><span class="p">:</span><span class="w">      </span><span class="mf">1.0.9</span>
<span class="w">  </span><span class="nl">portfolioName</span><span class="p">:</span><span class="w">        </span><span class="err">&#39;</span><span class="n">TODO</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">WITH</span><span class="w"> </span><span class="n">PORTFOLIO</span><span class="w"> </span><span class="n">NAME</span><span class="err">&#39;</span>
<span class="w">  </span><span class="nl">productName</span><span class="p">:</span><span class="w">          </span><span class="err">&#39;</span><span class="n">TODO</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">WITH</span><span class="w"> </span><span class="n">PRODUCT</span><span class="w"> </span><span class="n">NAME</span><span class="err">&#39;</span>
<span class="w">  </span><span class="nl">productGuid</span><span class="p">:</span><span class="w">          </span><span class="err">&#39;</span><span class="n">TODO</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">WITH</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">NEW</span><span class="w"> </span><span class="n">GUID</span><span class="w"> </span><span class="n">WITHOUT</span><span class="w"> </span><span class="n">BRACKETS</span><span class="err">&#39;</span>

<span class="cp"># Repository resources</span>
<span class="nl">resources</span><span class="p">:</span>
<span class="w">  </span><span class="nl">repositories</span><span class="p">:</span>
<span class="w">  </span><span class="cp"># =======================================================================</span>
<span class="w">  </span><span class="cp"># SKULL &amp; CROSS-BONES - DO NOT COMMENT OUT, OR REMOVE THIS SECTION</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">repository</span><span class="o">:</span><span class="w"> </span><span class="n">CDTemplates</span>
<span class="w">    </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="n">git</span>
<span class="w">    </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Common</span><span class="o">-</span><span class="n">Engineering</span><span class="o">-</span><span class="n">System</span><span class="o">/</span><span class="n">AzureDevOps</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">Pipeline</span><span class="p">.</span><span class="n">Templates</span><span class="err">&#39;</span>
<span class="w">  </span><span class="cp"># =======================================================================</span>

<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp"># START OF BUILD and TEST STAGE</span>
<span class="cp"># - GitVersion task looks at your Git history and works out the semantic </span>
<span class="cp">#   version of the commit being built.</span>
<span class="cp"># --------------------------------------------------------------------------</span>
<span class="nl">stages</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">  </span><span class="nl">displayName</span><span class="p">:</span><span class="w"> </span><span class="n">Continuous</span><span class="w"> </span><span class="n">Integration</span>
<span class="w">  </span><span class="nl">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">job</span><span class="o">:</span><span class="w"> </span><span class="n">ContinuousIntegration</span>
<span class="w">    </span><span class="nl">steps</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">gitversion</span><span class="o">/</span><span class="n">setup</span><span class="mi">@0</span>
<span class="w">      </span><span class="nl">displayName</span><span class="p">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">GitVersion</span>
<span class="w">      </span><span class="nl">inputs</span><span class="p">:</span>
<span class="w">        </span><span class="nl">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mf">5.</span><span class="n">x</span><span class="err">&#39;</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">gitversion</span><span class="o">/</span><span class="n">execute</span><span class="mi">@0</span>
<span class="w">      </span><span class="nl">displayName</span><span class="p">:</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">GitVersion</span>

<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp"># PREREQUISITES</span>
<span class="cp"># - Run steps that have to run before the build here, for example NPM, NuGet</span>
<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp">#   TODO Insert your scripts, steps, and tasks here and remove this comment</span>

<span class="cp"># ==========================================================================</span>
<span class="cp"># BOOTSTRAP VALIDATION, STAGE: CI_BOOTSTRAP_INIT</span>
<span class="cp"># SKULL &amp; CROSS-BONES - DO NOT COMMENT OUT, OR REMOVE THIS SECTION</span>
<span class="cp"># ==========================================================================</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="o">:</span><span class="w"> </span><span class="n">Templates</span><span class="o">/</span><span class="n">Bootstrap</span><span class="p">.</span><span class="n">yml</span><span class="p">@</span><span class="n">CDTemplates</span>
<span class="w">      </span><span class="nl">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nl">bootstrapMode</span><span class="p">:</span><span class="w">    </span><span class="err">&#39;</span><span class="n">init</span><span class="err">&#39;</span>
<span class="w">        </span><span class="nl">applicationType</span><span class="p">:</span><span class="w">  </span><span class="err">&#39;</span><span class="n">TODO</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">WITH</span><span class="w"> </span><span class="n">SUPPORTED</span><span class="w"> </span><span class="n">TYPE</span><span class="err">&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">dotnet</span><span class="p">,</span><span class="w"> </span><span class="n">angular</span>
<span class="w">        </span><span class="nl">applicationGuid</span><span class="p">:</span><span class="w">  </span><span class="n">$</span><span class="p">(</span><span class="n">productGuid</span><span class="p">)</span>
<span class="w">        </span><span class="nl">portfolioName</span><span class="p">:</span><span class="w">    </span><span class="n">$</span><span class="p">(</span><span class="n">portfolioName</span><span class="p">)</span>
<span class="w">        </span><span class="nl">productName</span><span class="p">:</span><span class="w">      </span><span class="n">$</span><span class="p">(</span><span class="n">productName</span><span class="p">)</span>
<span class="w">        </span><span class="nl">sourcesDirectory</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="n">SourcesDirectory</span><span class="p">)</span>
<span class="cp"># ==========================================================================</span>

<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp"># CONTINUOUS INTEGRATION BUILD</span>
<span class="cp"># - Run steps/tasks to build your solution here. </span>
<span class="cp"># - Move initialisations (NPM, NuGet,...) to PREREQUISITES section</span>
<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp">#  TODO Insert your scripts, steps, and tasks here and remove these comments</span>

<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp"># CONTINUOUS INTEGRATION TEST</span>
<span class="cp"># - Run steps/tasks to test your solution here</span>
<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp">#   TODO Insert your scripts, steps, and tasks here and remove this comment</span>

<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp"># PUBLISH</span>
<span class="cp"># - Publish the build and test artifacts</span>
<span class="cp"># --------------------------------------------------------------------------</span>
<span class="cp">#   TODO Insert build and test artifact publication tasks</span>

<span class="cp"># ==========================================================================</span>
<span class="cp"># BOOTSTRAP VALIDATION, STAGE: CI_BOOTSTRAP</span>
<span class="cp"># SKULL &amp; CROSS-BONES - DO NOT COMMENT OUT, OR REMOVE THIS SECTION</span>
<span class="cp"># ==========================================================================</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">template</span><span class="o">:</span><span class="w"> </span><span class="n">Templates</span><span class="o">/</span><span class="n">Bootstrap</span><span class="p">.</span><span class="n">yml</span><span class="p">@</span><span class="n">CDTemplates</span>
<span class="w">      </span><span class="nl">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nl">bootstrapMode</span><span class="p">:</span><span class="w">    </span><span class="err">&#39;</span><span class="n">run</span><span class="err">&#39;</span>
<span class="w">        </span><span class="nl">applicationType</span><span class="p">:</span><span class="w">  </span><span class="err">&#39;</span><span class="n">TODO</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">WITH</span><span class="w"> </span><span class="n">SUPPORTED</span><span class="w"> </span><span class="n">TYPE</span><span class="err">&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">dotnet</span><span class="p">,</span><span class="w"> </span><span class="n">angular</span>
<span class="w">        </span><span class="nl">applicationGuid</span><span class="p">:</span><span class="w">  </span><span class="n">$</span><span class="p">(</span><span class="n">productGuid</span><span class="p">)</span>
<span class="w">        </span><span class="nl">portfolioName</span><span class="p">:</span><span class="w">    </span><span class="n">$</span><span class="p">(</span><span class="n">portfolioName</span><span class="p">)</span>
<span class="w">        </span><span class="nl">productName</span><span class="p">:</span><span class="w">      </span><span class="n">$</span><span class="p">(</span><span class="n">productName</span><span class="p">)</span>
<span class="w">        </span><span class="nl">sourcesDirectory</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="n">SourcesDirectory</span><span class="p">)</span>
<span class="cp"># ==========================================================================</span>
</code></pre></div>

<p>Engineers can <strong>copy-paste</strong> this blueprint into their application repository, look for <strong>TODO</strong>s, update and fine-tune the pipeline as needed. Sections which should not be deleted or changed are enclosed in skull &amp; cross-bones markers. <strong>Simple!</strong></p>
<p>The other <strong>generic</strong> template, azure-pipeline-multiple-jobs.yml, enables engineers to craft multi-job pipelines, enabling features such as parallelism. </p>
<blockquote>
<p>azure-pipeline-multiple-jobs.yml flow
<img alt="azure-pipeline-multiple-jobs.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-2.png"></p>
</blockquote>
<p>As shown, the blueprint defines two jobs, one including the <strong>initialisation</strong> and <strong>build</strong> sections, and the other the <strong>test</strong> section. Some tasks, such as the <strong>SonarQube</strong> tasks have to run within the same job context, which is why the blueprint injects the bootstrap template three times. As before, the first injects the <strong>bootstrap</strong> template with an <strong>init</strong> parameter, to inject initialisation templates, with tasks such as <strong>SonarQube Prepare</strong>. The second injects the <strong>bootstrap</strong> template with a <strong>devsecopsonly</strong> parameter, which magically injects all of the DevSecOps scans, such as <strong>SonarQube Analyse</strong>, <strong>SonarQube Publish</strong>, and <strong>WhiteSource</strong>. The remaining templates, such as the <strong>Building Code</strong> are only injected at the end when the third call is made to the <strong>bootstrap</strong> template with the <strong>buildingcodeonly</strong> parameter.</p>
<p>To summarise, we are trying to simplify our pipeline environment and empower both development and operations with these blueprints. </p>
<p><strong>But</strong>, we can do better!</p>
<hr>
<h1>App-type Blueprints</h1>
<p>With application-type, in short app-type, blueprints we are taking the continuous integration (CI) pipelines light-years further in terms of our goals for <strong>simplicity</strong>, <strong>security</strong>, <strong>enablement</strong>, and <strong>consistency</strong>. Each app-type blueprint, based on our pipeline champion Said Akram's (@said-akram-wcbbc) ingenious proof-of-concept, consists of a <strong>starter</strong> template, an <strong>app-type</strong> template, and a reference <strong>sample</strong> implementation, as shown below.</p>
<blockquote>
<p>App-type blueprint parts</p>
<p><img alt="azure-pipeline-multiple-jobs.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-7.png"></p>
</blockquote>
<p>The <strong>starter</strong> template allows our engineers to configure their continuous integration pipeline, after they <strong>copy-paste</strong> it into their application repository. This is the only moving part that is copied and becomes part of the application code base.</p>
<blockquote>
<p>SAMPLE - Azure Function <strong>starter</strong> template</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">trigger</span><span class="o">:</span>
<span class="w">  </span><span class="n">batch</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">true</span><span class="o">;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="n">branches</span><span class="o">:</span>
<span class="w">    </span><span class="k">include</span><span class="o">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Trigger</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">branches</span>

<span class="n">resources</span><span class="o">:</span>
<span class="w">  </span><span class="n">repositories</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">repository</span><span class="o">:</span><span class="w"> </span><span class="n">CDAppTemplates</span>
<span class="w">    </span><span class="n">type</span><span class="o">:</span><span class="w">       </span><span class="n">git</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w">       </span><span class="s1">&#39;Common-Engineering-System/AzureDevOps.Automation.Pipeline.AppTemplates&#39;</span>

<span class="err">#</span><span class="w"> </span><span class="n">Semantic</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">Common</span><span class="w"> </span><span class="n">Engineering</span><span class="w"> </span><span class="n">Naming</span><span class="w"> </span><span class="n">Conventions</span><span class="o">.</span>
<span class="n">name</span><span class="o">:</span>
<span class="w">  </span><span class="n">$</span><span class="o">(</span><span class="n">portfolioName</span><span class="o">)</span><span class="n">_$</span><span class="o">(</span><span class="n">productName</span><span class="o">)</span><span class="n">_$</span><span class="o">(</span><span class="n">GITVERSION_MAJORMINORPATCH</span><span class="o">)</span><span class="n">_$</span><span class="o">(</span><span class="n">date</span><span class="o">:</span><span class="n">yyyyMMdd</span><span class="o">).</span><span class="n">$</span><span class="o">(</span><span class="n">date</span><span class="o">:</span><span class="n">HHmmss</span><span class="o">).</span><span class="n">$</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">SourceBranchName</span><span class="o">)</span>

<span class="err">#</span><span class="w"> </span><span class="n">VARIABLES</span>
<span class="n">variables</span><span class="o">:</span>
<span class="w">  </span><span class="n">portfolioName</span><span class="o">:</span><span class="w">    </span><span class="s1">&#39;TODO REPLACE WITH PORTFOLIO NAME&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="w"> </span><span class="n">StarWars</span>
<span class="w">  </span><span class="n">productName</span><span class="o">:</span><span class="w">      </span><span class="s1">&#39;TODO REPLACE WITH PRODUCT NAME&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="w"> </span><span class="n">Imperial</span><span class="o">.</span><span class="na">Star</span><span class="o">-</span><span class="n">Destroyer</span>

<span class="kd">extends</span><span class="o">:</span>
<span class="w">  </span><span class="n">template</span><span class="o">:</span><span class="w"> </span><span class="n">Templates</span><span class="sr">/AzureFunction/</span><span class="n">azureFunctionTemplate</span><span class="o">.</span><span class="na">yml</span><span class="err">@</span><span class="n">CDAppTemplates</span>
<span class="w">  </span><span class="n">parameters</span><span class="o">:</span>
<span class="w">    </span><span class="n">updateAssemblyInfo</span><span class="o">:</span><span class="w">     </span><span class="kc">false</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Optional</span><span class="o">.</span><span class="w"> </span><span class="n">Options</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">false</span><span class="o">.</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">AssemblyInfo</span><span class="w"> </span><span class="n">files</span>
<span class="w">    </span><span class="n">netCoreVersion</span><span class="o">:</span><span class="w">         </span><span class="s1">&#39;TODO REPLACE WITH .NET CORE VERSION&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="w"> </span><span class="mf">3.1</span><span class="o">.</span><span class="na">x</span>
<span class="w">    </span><span class="n">applicationGuid</span><span class="o">:</span><span class="w">        </span><span class="s1">&#39;TODO REPLACE WITH A NEW GUID WITHOUT BRACKETS&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="w"> </span><span class="mi">257929</span><span class="n">e89c69471083efb51899b42bdb</span>
<span class="w">    </span><span class="n">portfolioName</span><span class="o">:</span><span class="w">          </span><span class="n">$</span><span class="o">(</span><span class="n">portfolioName</span><span class="o">)</span>
<span class="w">    </span><span class="n">productName</span><span class="o">:</span><span class="w">            </span><span class="n">$</span><span class="o">(</span><span class="n">productName</span><span class="o">)</span>
<span class="w">    </span><span class="n">restoreBuildProjects</span><span class="o">:</span><span class="w">   </span><span class="s1">&#39;**/*.csproj&#39;</span>
<span class="w">    </span><span class="n">vstsFeed</span><span class="o">:</span><span class="w">               </span><span class="s1">&#39;11111111-2222-3333-4444-555555555555&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">_NuGet</span><span class="w"> </span><span class="n">feed</span>
<span class="w">    </span><span class="n">buildConfiguration</span><span class="o">:</span><span class="w">     </span><span class="s1">&#39;Release&#39;</span>
</code></pre></div>

<p>The <strong>starter</strong> template <strong>extends</strong> the pipeline with the <strong>app-type</strong> template, in our example the azureFunctionTemplate.yml. With this <strong>magic</strong> we introduce the template <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/security/templates?view=azure-devops#use-extends-templates"><strong>extend</strong></a> feature, which sprinkles a dash of <strong>security</strong> on our pipelines, as we can now check that a pipeline is extended from a trusted template in <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments?view=azure-devops">environment</a> and <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml">service connection</a> approvals and checks. </p>
<blockquote>
<p>Required template checks</p>
<p><img alt="azure-pipeline-multiple-jobs.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-4.png"></p>
</blockquote>
<p>The <strong>app-type</strong> template is visible, but not modifiable for the owner of the pipeline. We abstract the entire continuous integration (CI) process from the engineers, which promotes <strong>consistency</strong>, delegates <strong>responsibility</strong> for the implementation to our common engineering system team, and <strong>encourages</strong> engineers to be razor-focused on their application. The complexity of injecting our <strong>bootstrap</strong> and associated templates, task sequence, stage and job context, and pipeline plumbing we discussed in previous parts, is abstracted (hidden). </p>
<p>Let us briefly review this with a visual.</p>
<blockquote>
<p>azure-pipeline-single-job.yml Custom Template</p>
<p><img alt="azure-pipeline-multiple-jobs.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-5.png"></p>
</blockquote>
<p>With the <strong>custom</strong> blueprints the starter template presents a much larger exposure area, where we can observe template drift, vulnerability injections, and complexity that the engineering teams should not have to worry about. As discussed, the latest <strong>bootstrap</strong> and associated templates are pulled from the <code>*.Templates</code> repository and injected into the pipeline instance at queue time.</p>
<p>Time to reiterate ... we can do better!</p>
<blockquote>
<p>AzureFunctionTemplate.yml Starter Template</p>
<p><img alt="azure-pipeline-multiple-jobs.yml" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-6.png"></p>
</blockquote>
<p>With the <strong>app-type</strong> blueprints, the starter template has a much smaller exposure area. The latest <strong>app-type</strong> template is pulled from the <code>*.AppTemplates</code> repository, which in turn injects the latest <strong>bootstrap</strong> and associated templates from the <code>*.Templates</code> repository.</p>
<p>You should appreciate the magic of the YAML pipelines by now!</p>
<hr>
<h1>Enabling continuous innovation and rapid change</h1>
<p>We always start our YAML awareness and training workshops with the following scenario and question: "<em>Assume we have 1000 classic pipelines and 1000 YAML pipelines, and we need to make a change to one of the pipeline tasks that takes approximately 1 minute. How long will it take us to change all of the classic pipelines and all of the YAM pipelines?</em>"</p>
<p>We then give everyone 5 minutes to discuss and place their bets. Discussions vary, but usually include reference to mind-numbing classic pipeline editor, <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/task-groups?view=azure-devops">Task groups</a>, code search and replace, followed by vibrant debates and eventually stunned silence ... the proverbial "room full of crickets."</p>
<p>It is a trick question, because it depends on how the pipelines are designed, which can vary from minutes to days of effort. </p>
<p>What should be evident, however, is that any change will be <strong>faster</strong>, <strong>simpler</strong>, and <strong>safer</strong> to make if the <strong>consistency</strong> of our pipelines is high, and the <strong>exposure area</strong> is small. </p>
<p>We recently received a request from DevSecOps to change all our pipelines to always run the DevSecOps scans, instead of just as part of pull request validation builds. It literally took us minute to create a feature branch, tweak the bootstrap template, and validate the change with a collaborative pull request. Once merged into the *.Templates repository, all new pipeline instances showcased the new default behaviour. DevSecOps were happy and the engineering teams unaware of any change.</p>
<hr>
<h1>Enabling automation</h1>
<p>Lastly, we realised that our self-service automation goal is also no longer a distant dream. The app-type templates enable us to ask the engineering teams a few questions, then run automation that creates a new application repository and pipeline in seconds - and consistently! That, however, is a story for another day in Part 7: Self-service automation - A dream turns into reality q;)</p>
<hr>
<h1>What is next?</h1>
<p>We have now covered the continuous integration (CI), also referred to as build, pipeline though the lens of YAML. You can think of the <strong>blueprints</strong> and associated <strong>templates</strong> as re-usable LEGO blocks, ranging from a bag of "do it yourself" blocks, to complex and detailed kits, such as the Imperial Star Destroyer.</p>
<blockquote>
<p>LEGO Imperial Star Destroyer kit</p>
<p><img alt="LEGO Image" src="/images/moving-hundreds-of-pipeline-snowflakes-part5-3.png"> </p>
</blockquote>
<p>Next, we will explore continuous deployment (CD). See you in part 6 (coming soon).</p>
<hr>
<blockquote>
<p>Series Bread Crumbs | <a href="/why-pipelines-part1.html">Part 1, TOC</a> | <a href="/yaml-pipelines-part2.html">Part 2</a> | <a href="/yaml-pipelines-part3.html">Part 3</a> | <a href="/yaml-pipelines-part4.html">Part 4</a> | <a href="/yaml-pipelines-part5.html">Part 5</a> | <a href="/yaml-pipelines-part6.html">Part 6</a> | <a href="/yaml-pipelines-part7.html">Part 7</a> |  <a href="/yaml-pipelines-part8.html">Part 8</a> | <a href="/yaml-pipelines-part9.html">Part 9</a> | <a href="/yaml-pipelines-part10.html">Part 10</a> | <a href="/yaml-pipelines-part11.html">Part 11</a> |</p>
</blockquote>
        </div>

    </section>
    <footer class="footer-article">
        <div class="tags-and-categories">Filed under <a href="https://wsbctechnicalblog.github.io/category/posts.html">Posts</a>
        | Tagged: <a href="https://wsbctechnicalblog.github.io/tag/azure-devops.html">azure-devops </a><a href="https://wsbctechnicalblog.github.io/tag/devops.html">devops </a><a href="https://wsbctechnicalblog.github.io/tag/pipelines.html">pipelines </a><a href="https://wsbctechnicalblog.github.io/tag/x-as-code.html">x-as-code </a>
        | <a href="https://wsbctechnicalblog.github.io/yaml-pipelines-part5.html" rel="bookmark"
         title="Permalink to Part 5: Pipelines - Blueprints to fuel consistency and enablement">Permalink</a>            
        </div>
        <!-- metaldata 
        -->
    </footer>
        <hr>
        <div id="gisqus_thread"></div>
        <script src="https://giscus.app/client.js"
            data-repo="WorkSafeBC-Common-Engineering/Common.Engineering.Discussion"
            data-repo-id="R_kgDOIGjt-Q"
            data-category="Technical Blog"
            data-category-id="DIC_kwDOIGjt-c4CU007"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="light"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
        </script></div>
            </div>
            <div class="large-2 aside column">
                <h3>Links</h3>
                <ul>
                    <li><a href="https://www.worksafebc.com/en">WorkSafeBC</a></li>
                    <li><a href="https://www.worksafebc.com/en/about-us/news-events/campaigns/2019/September/connect-to-an-it-career-with-a-difference">WorkSafeBC IT is hiring</a></li>
                    <li><a href="https://www.worksafebc.com/en/about-us/careers">Careers</a></li>
                    <li><a href="https://wsbctechnicalblog.github.io/feeds/posts.atom.xml">ATOM/RSS Feed</a></li>
                </ul>
            </div>
         </div>
    </div>
</div>
    <div class="footer">
        <div class="data-holder">
        <div class="row">
            <div class="large-3 column">
<div class="credits">
    <h3>WorkSafeBC</h3>
    <p><a href="/pages/copyright.html">Copyright</a>&nbsp;|<br /><a href="/pages/terms-of-use.html">Terms&nbsp;and&nbsp;Conditions</a></p>
</div>           </div>
           <div class="large-6 tag-cloud column">
                <h3>Tags</h3>
                <ul>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/code.html">code</a>(26)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/code-quality.html">code-quality</a>(14)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/engineering.html">engineering</a>(54)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/technical-excellence.html">technical-excellence</a>(20)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/azure-devops.html">azure-devops</a>(82)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/pipelines.html">pipelines</a>(55)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/automation.html">automation</a>(23)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/ai.html">ai</a>(18)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/event.html">event</a>(10)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/learning.html">learning</a>(52)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/posters.html">posters</a>(11)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/agile.html">agile</a>(35)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/devops.html">devops</a>(52)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/journal.html">journal</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/101.html">101</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/eliminate-waste.html">eliminate-waste</a>(24)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/ceremony.html">ceremony</a>(8)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/quality.html">quality</a>(19)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/tips.html">tips</a>(28)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/oss.html">oss</a>(6)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/github.html">github</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/standards.html">standards</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/azure.html">azure</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/water-cooler.html">water-cooler</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/innovation.html">innovation</a>(7)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/design.html">design</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/testing.html">testing</a>(15)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/release.html">release</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/x-as-code.html">x-as-code</a>(16)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/book.html">book</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/version-control.html">version-control</a>(4)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/metrics.html">metrics</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/continuous-delivery.html">continuous-delivery</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/delivery-on-demand.html">delivery-on-demand</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/architecture.html">architecture</a>(5)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/collaboration.html">collaboration</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/team-building.html">team-building</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/no-estimates.html">no-estimates</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/tdd.html">TDD</a>(12)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/estimates.html">estimates</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/strategy.html">strategy</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/planning.html">planning</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/value.html">value</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/process.html">process</a>(2)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/flow.html">flow</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/lean.html">lean</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/customer-centric.html">customer-centric</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/psychological-safety.html">psychological-safety</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/dojo.html">dojo</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/testability.html">testability</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/system-programming.html">system-programming</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/xp.html">xp</a>(5)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/events.html">events</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/security.html">security</a>(1)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/feature-flags.html">feature-flags</a>(3)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/tag/workflow.html">workflow</a>(1)</li>
                </ul>
            </div>
            <div class="large-3 category-column column">
                <h3>Categories</h3>
                <ul>
                    <li><a href="https://wsbctechnicalblog.github.io/category/events.html">Events</a> (10)</li>
                    <li><a href="https://wsbctechnicalblog.github.io/category/misc.html">misc</a> (2)</li>
                    <li class="active"><a href="https://wsbctechnicalblog.github.io/category/posts.html">Posts</a> (211)</li>
                </ul>
             
            </div>
        </row>
        </div>
    </div>
</body>
</html>